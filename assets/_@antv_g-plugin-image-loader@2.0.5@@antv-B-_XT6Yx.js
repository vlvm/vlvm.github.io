import{_ as O,a as D,b as x}from"./_tslib@2.6.3@tslib-Ck5hgXZz.js";import{A as M,m as N,B as b,D as K,F as z,w as E,J as U,K as k,U as F,E as y,S as T}from"./_@antv_g-lite@2.0.5@@antv-O0rSGUp-.js";import{c as p}from"./_@antv_util@3.3.7@@antv-rk1Gsl7O.js";import{T as V,e as j,L as B}from"./_gl-matrix@3.4.3@gl-matrix-Cx0TVU2o.js";var _=function(){function h(e){this.canvasConfig=e,this.imageCache={},this.gradientCache={},this.patternCache={}}return h.prototype.getImageSync=function(e,t){return this.imageCache[e]?t&&t(this.imageCache[e]):this.getOrCreateImage(e).then(function(a){t&&t(a)}),this.imageCache[e]},h.prototype.getOrCreateImage=function(e){var t=this;if(this.imageCache[e])return Promise.resolve(this.imageCache[e]);var a=this.canvasConfig.createImage;return new Promise(function(l,f){var o;a?o=a(e):N&&(o=new window.Image),o&&(o.onload=function(){t.imageCache[e]=o,l(o)},o.onerror=function(c){f(c)},o.crossOrigin="Anonymous",o.src=e)})},h.prototype.getOrCreatePatternSync=function(e,t,a,l,f,o){var c=this.generatePatternKey(e);if(c&&this.patternCache[c])return this.patternCache[c];var u=e.image,s=e.repetition,r=e.transform,g,d=!1;p(u)?g=this.getImageSync(u,o):a?(g=a,d=!0):g=u;var i=g&&t.createPattern(g,s);if(i){var n=void 0;r?n=b(z(r),new K({})):n=V(j()),d&&B(n,n,[1/l,1/l,1]),i.setTransform({a:n[0],b:n[1],c:n[4],d:n[5],e:n[12]+f[0],f:n[13]+f[1]})}return c&&i&&(this.patternCache[c]=i),i},h.prototype.getOrCreateGradient=function(e,t){var a=this.generateGradientKey(e),l=e.type,f=e.steps,o=e.min,c=e.width,u=e.height,s=e.angle,r=e.cx,g=e.cy,d=e.size;if(this.gradientCache[a])return this.gradientCache[a];var i=null;if(l===E.LinearGradient){var n=U(o,c,u,s),v=n.x1,m=n.y1,C=n.x2,G=n.y2;i=t.createLinearGradient(v,m,C,G)}else if(l===E.RadialGradient){var w=k(o,c,u,r,g,d),P=w.x,I=w.y,R=w.r;i=t.createRadialGradient(P,I,0,P,I,R)}return i&&(f.forEach(function(S){var A=S.offset,L=S.color;A.unit===F.kPercentage&&(i==null||i.addColorStop(A.value/100,L.toString()))}),this.gradientCache[a]=i),this.gradientCache[a]},h.prototype.generateGradientKey=function(e){var t=e.type,a=e.min,l=e.width,f=e.height,o=e.steps,c=e.angle,u=e.cx,s=e.cy,r=e.size;return"gradient-".concat(t,"-").concat((c==null?void 0:c.toString())||0,"-").concat((u==null?void 0:u.toString())||0,"-").concat((s==null?void 0:s.toString())||0,"-").concat((r==null?void 0:r.toString())||0,"-").concat(a[0],"-").concat(a[1],"-").concat(l,"-").concat(f,"-").concat(o.map(function(g){var d=g.offset,i=g.color;return"".concat(d).concat(i)}).join("-"))},h.prototype.generatePatternKey=function(e){var t=e.image,a=e.repetition;if(p(t))return"pattern-".concat(t,"-").concat(a);if(t.nodeName==="rect")return"pattern-".concat(t.entity,"-").concat(a)},h}(),J=function(){function h(){}return h.prototype.apply=function(e){var t=e.renderingService,a=e.renderingContext,l=e.imagePool,f=a.root.ownerDocument.defaultView,o=function(s,r,g){var d=s.parsedStyle,i=d.width,n=d.height;i&&!n?s.setAttribute("height",g/r*i):!i&&n&&s.setAttribute("width",r/g*n)},c=function(s){var r=s.target,g=r.nodeName,d=r.attributes;if(g===T.IMAGE){var i=d.src,n=d.keepAspectRatio;p(i)&&l.getImageSync(i,function(v){var m=v.width,C=v.height;n&&o(r,m,C),r.renderable.dirty=!0,t.dirtify()})}},u=function(s){var r=s.target,g=s.attrName,d=s.newValue;r.nodeName===T.IMAGE&&g==="src"&&p(d)&&l.getOrCreateImage(d).then(function(i){var n=i.width,v=i.height;r.attributes.keepAspectRatio&&o(r,n,v),r.renderable.dirty=!0,t.dirtify()})};t.hooks.init.tap(h.tag,function(){f.addEventListener(y.MOUNTED,c),f.addEventListener(y.ATTR_MODIFIED,u)}),t.hooks.destroy.tap(h.tag,function(){f.removeEventListener(y.MOUNTED,c),f.removeEventListener(y.ATTR_MODIFIED,u)})},h.tag="LoadImage",h}(),Y=function(h){O(e,h);function e(){var t=h.apply(this,D([],x(arguments),!1))||this;return t.name="image-loader",t}return e.prototype.init=function(){this.context.imagePool=new _(this.context.config),this.addRenderingPlugin(new J)},e.prototype.destroy=function(){this.removeAllRenderingPlugins()},e}(M);export{Y as P};
