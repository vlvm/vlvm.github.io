import{_ as Y,d as te,a as me,b as ae}from"./_tslib@2.6.3@tslib-Ck5hgXZz.js";import{S as w,v as he,w as oe,A as ge,E as Z,x as z,e as ce,y as ye,N as Ae}from"./_@antv_g-lite@2.0.5@@antv-O0rSGUp-.js";import{p as M,c as we}from"./_@antv_util@3.3.7@@antv-rk1Gsl7O.js";import{e as ie,y as q,g as Be,u as K,R as x,z as le}from"./_gl-matrix@3.4.3@gl-matrix-Cx0TVU2o.js";var Re=function(){function i(e){this.canvasRendererPluginOptions=e,this.removedRBushNodeAABBs=[],this.renderQueue=[],this.restoreStack=[],this.clearFullScreenLastFrame=!1,this.clearFullScreen=!1,this.vpMatrix=ie(),this.dprMatrix=ie(),this.tmpMat4=ie(),this.vec3a=q(),this.vec3b=q(),this.vec3c=q(),this.vec3d=q()}return i.prototype.apply=function(e,a){var r=this;this.context=e;var n=e.config,s=e.camera,o=e.renderingService,t=e.renderingContext,l=e.rBushRoot,v=e.pathGeneratorFactory;this.rBush=l,this.pathGeneratorFactory=v;var d=e.contextService,u=t.root.ownerDocument.defaultView,y=function(h){var f=h.target,m=f.rBushNode;m.aabb&&r.removedRBushNodeAABBs.push(m.aabb)},p=function(h){var f=h.target,m=f.rBushNode;m.aabb&&r.removedRBushNodeAABBs.push(m.aabb)};o.hooks.init.tap(i.tag,function(){u.addEventListener(Z.UNMOUNTED,y),u.addEventListener(Z.CULLED,p);var h=d.getDPR(),f=n.width,m=n.height,c=d.getContext();r.clearRect(c,0,0,f*h,m*h,n.background)}),o.hooks.destroy.tap(i.tag,function(){u.removeEventListener(Z.UNMOUNTED,y),u.removeEventListener(Z.CULLED,p),r.renderQueue=[],r.removedRBushNodeAABBs=[],r.restoreStack=[]}),o.hooks.beginFrame.tap(i.tag,function(){var h,f=d.getContext(),m=d.getDPR(),c=n.width,T=n.height,A=r.canvasRendererPluginOptions,N=A.dirtyObjectNumThreshold,E=A.dirtyObjectRatioThreshold,B=o.getStats(),R=B.total,O=B.rendered,L=O/R;r.clearFullScreen=r.clearFullScreenLastFrame||!(!((h=u.context.renderingPlugins[1])===null||h===void 0)&&h.isFirstTimeRenderingFinished)||o.disableDirtyRectangleRendering()||O>N&&L>E,f&&(f.resetTransform?f.resetTransform():f.setTransform(1,0,0,1,0,0),r.clearFullScreen&&r.clearRect(f,0,0,c*m,T*m,n.background))});var g=function(h,f){h.isVisible()&&!h.isCulled()&&r.renderDisplayObject(h,f,r.context,r.restoreStack,a);var m=h.sortable.sorted||h.childNodes;m.forEach(function(c){g(c,f)})};o.hooks.endFrame.tap(i.tag,function(){if(t.root.childNodes.length===0){r.clearFullScreenLastFrame=!0;return}r.clearFullScreenLastFrame=!1;var h=d.getContext(),f=d.getDPR();if(Be(r.dprMatrix,[f,f,1]),K(r.vpMatrix,r.dprMatrix,s.getOrthoMatrix()),r.clearFullScreen)g(t.root,h);else{var m=r.safeMergeAABB.apply(r,me([r.mergeDirtyAABBs(r.renderQueue)],ae(r.removedRBushNodeAABBs.map(function(P){var J=P.minX,X=P.minY,W=P.maxX,V=P.maxY,$=new z;return $.setMinMax([J,X,0],[W,V,0]),$})),!1));if(r.removedRBushNodeAABBs=[],z.isEmpty(m)){r.renderQueue=[];return}var c=r.convertAABB2Rect(m),T=c.x,A=c.y,N=c.width,E=c.height,B=x(r.vec3a,[T,A,0],r.vpMatrix),R=x(r.vec3b,[T+N,A,0],r.vpMatrix),O=x(r.vec3c,[T,A+E,0],r.vpMatrix),L=x(r.vec3d,[T+N,A+E,0],r.vpMatrix),k=Math.min(B[0],R[0],L[0],O[0]),F=Math.min(B[1],R[1],L[1],O[1]),S=Math.max(B[0],R[0],L[0],O[0]),I=Math.max(B[1],R[1],L[1],O[1]),D=Math.floor(k),C=Math.floor(F),H=Math.ceil(S-k),Q=Math.ceil(I-F);h.save(),r.clearRect(h,D,C,H,Q,n.background),h.beginPath(),h.rect(D,C,H,Q),h.clip(),h.setTransform(r.vpMatrix[0],r.vpMatrix[1],r.vpMatrix[4],r.vpMatrix[5],r.vpMatrix[12],r.vpMatrix[13]);var ee=n.renderer.getConfig().enableDirtyRectangleRenderingDebug;ee&&u.dispatchEvent(new ce(ye.DIRTY_RECTANGLE,{dirtyRect:{x:D,y:C,width:H,height:Q}}));var re=r.searchDirtyObjects(m);re.sort(function(P,J){return P.sortable.renderOrder-J.sortable.renderOrder}).forEach(function(P){P&&P.isVisible()&&!P.isCulled()&&r.renderDisplayObject(P,h,r.context,r.restoreStack,a)}),h.restore(),r.renderQueue.forEach(function(P){r.saveDirtyAABB(P)}),r.renderQueue=[]}r.restoreStack.forEach(function(){h.restore()}),r.restoreStack=[]}),o.hooks.render.tap(i.tag,function(h){r.clearFullScreen||r.renderQueue.push(h)})},i.prototype.clearRect=function(e,a,r,n,s,o){e.clearRect(a,r,n,s),o&&(e.fillStyle=o,e.fillRect(a,r,n,s))},i.prototype.renderDisplayObject=function(e,a,r,n,s){var o=e.nodeName,t=n[n.length-1];t&&!(e.compareDocumentPosition(t)&Ae.DOCUMENT_POSITION_CONTAINS)&&(a.restore(),n.pop());var l=this.context.styleRendererFactory[o],v=this.pathGeneratorFactory[o],d=e.parsedStyle.clipPath;if(d){this.applyWorldTransform(a,d);var u=this.pathGeneratorFactory[d.nodeName];u&&(a.save(),n.push(e),a.beginPath(),u(a,d.parsedStyle),a.closePath(),a.clip())}l&&(this.applyWorldTransform(a,e),a.save(),this.applyAttributesToContext(a,e)),v&&(a.beginPath(),v(a,e.parsedStyle),e.nodeName!==w.LINE&&e.nodeName!==w.PATH&&e.nodeName!==w.POLYLINE&&a.closePath()),l&&(l.render(a,e.parsedStyle,e,r,this,s),a.restore()),e.renderable.dirty=!1},i.prototype.convertAABB2Rect=function(e){var a=e.getMin(),r=e.getMax(),n=Math.floor(a[0]),s=Math.floor(a[1]),o=Math.ceil(r[0]),t=Math.ceil(r[1]),l=o-n,v=t-s;return{x:n,y:s,width:l,height:v}},i.prototype.mergeDirtyAABBs=function(e){var a=new z;return e.forEach(function(r){var n=r.getRenderBounds();a.add(n);var s=r.renderable.dirtyRenderBounds;s&&a.add(s)}),a},i.prototype.searchDirtyObjects=function(e){var a=ae(e.getMin(),2),r=a[0],n=a[1],s=ae(e.getMax(),2),o=s[0],t=s[1],l=this.rBush.search({minX:r,minY:n,maxX:o,maxY:t});return l.map(function(v){var d=v.displayObject;return d})},i.prototype.saveDirtyAABB=function(e){var a=e.renderable;a.dirtyRenderBounds||(a.dirtyRenderBounds=new z);var r=e.getRenderBounds();r&&a.dirtyRenderBounds.update(r.center,r.halfExtents)},i.prototype.applyAttributesToContext=function(e,a){var r=a.parsedStyle,n=r.stroke,s=r.fill,o=r.opacity,t=r.lineDash,l=r.lineDashOffset;t&&e.setLineDash(t),M(l)||(e.lineDashOffset=l),M(o)||(e.globalAlpha*=o),!M(n)&&!Array.isArray(n)&&!n.isNone&&(e.strokeStyle=a.attributes.stroke),!M(s)&&!Array.isArray(s)&&!s.isNone&&(e.fillStyle=a.attributes.fill)},i.prototype.applyWorldTransform=function(e,a,r){r?(le(this.tmpMat4,a.getLocalTransform()),K(this.tmpMat4,r,this.tmpMat4),K(this.tmpMat4,this.vpMatrix,this.tmpMat4)):(le(this.tmpMat4,a.getWorldTransform()),K(this.tmpMat4,this.vpMatrix,this.tmpMat4)),e.setTransform(this.tmpMat4[0],this.tmpMat4[1],this.tmpMat4[4],this.tmpMat4[5],this.tmpMat4[12],this.tmpMat4[13])},i.prototype.safeMergeAABB=function(){for(var e=[],a=0;a<arguments.length;a++)e[a]=arguments[a];var r=new z;return e.forEach(function(n){r.add(n)}),r},i.tag="CanvasRenderer",i}(),G=function(){function i(e){this.imagePool=e}return i.prototype.render=function(e,a,r,n,s,o){var t=a.fill,l=a.fillRule,v=a.opacity,d=v===void 0?1:v,u=a.fillOpacity,y=u===void 0?1:u,p=a.stroke,g=a.strokeOpacity,h=g===void 0?1:g,f=a.lineWidth,m=f===void 0?1:f,c=a.lineCap,T=a.lineJoin,A=a.shadowType,N=a.shadowColor,E=a.shadowBlur,B=a.filter,R=a.miterLimit,O=t&&!t.isNone,L=p&&!p.isNone&&m>0,k=(t==null?void 0:t.alpha)===0,F=!!(B&&B.length),S=!M(N)&&E>0,I=r.nodeName,D=A==="inner",C=L&&S&&(I===w.PATH||I===w.LINE||I===w.POLYLINE||k||D);O&&(e.globalAlpha=d*y,C||j(r,e,S),ve(e,r,t,l,n,s,o,this.imagePool),C||this.clearShadowAndFilter(e,F,S)),L&&(e.globalAlpha=d*h,e.lineWidth=m,M(R)||(e.miterLimit=R),M(c)||(e.lineCap=c),M(T)||(e.lineJoin=T),C&&(D&&(e.globalCompositeOperation="source-atop"),j(r,e,!0),D&&(ne(e,r,p,n,s,o,this.imagePool),e.globalCompositeOperation="source-over",this.clearShadowAndFilter(e,F,!0))),ne(e,r,p,n,s,o,this.imagePool))},i.prototype.clearShadowAndFilter=function(e,a,r){if(r&&(e.shadowColor="transparent",e.shadowBlur=0),a){var n=e.filter;!M(n)&&n.indexOf("drop-shadow")>-1&&(e.filter=n.replace(/drop-shadow\([^)]*\)/,"").trim()||"none")}},i}();function j(i,e,a){var r=i.parsedStyle,n=r.filter,s=r.shadowColor,o=r.shadowBlur,t=r.shadowOffsetX,l=r.shadowOffsetY;n&&n.length&&(e.filter=i.style.filter),a&&(e.shadowColor=s.toString(),e.shadowBlur=o||0,e.shadowOffsetX=t||0,e.shadowOffsetY=l||0)}function de(i,e,a,r,n,s,o){var t,l;if(i.image.nodeName==="rect"){var v=i.image.parsedStyle,d=v.width,u=v.height;l=r.contextService.getDPR();var y=r.config.offscreenCanvas;t=s.offscreenCanvasCreator.getOrCreateCanvas(y),t.width=d*l,t.height=u*l;var p=s.offscreenCanvasCreator.getOrCreateContext(y),g=[];i.image.forEach(function(f){n.renderDisplayObject(f,p,r,g,s)}),g.forEach(function(){p.restore()})}var h=o.getOrCreatePatternSync(i,a,t,l,e.getGeometryBounds().min,function(){e.renderable.dirty=!0,r.renderingService.dirtify()});return h}function fe(i,e,a,r){var n;if(i.type===oe.LinearGradient||i.type===oe.RadialGradient){var s=e.getGeometryBounds(),o=s&&s.halfExtents[0]*2||1,t=s&&s.halfExtents[1]*2||1,l=s&&s.min||[0,0];n=r.getOrCreateGradient(te(te({type:i.type},i.value),{min:l,width:o,height:t}),a)}return n}function ve(i,e,a,r,n,s,o,t,l){l===void 0&&(l=!1),Array.isArray(a)?a.forEach(function(v){i.fillStyle=fe(v,e,i,t),l||(r?i.fill(r):i.fill())}):(he(a)&&(i.fillStyle=de(a,e,i,n,s,o,t)),l||(r?i.fill(r):i.fill()))}function ne(i,e,a,r,n,s,o,t){t===void 0&&(t=!1),Array.isArray(a)?a.forEach(function(l){i.strokeStyle=fe(l,e,i,o),t||i.stroke()}):(he(a)&&(i.strokeStyle=de(a,e,i,r,n,s,o)),t||i.stroke())}var Me=function(){function i(e){this.imagePool=e}return i.prototype.render=function(e,a,r){var n=a.x,s=n===void 0?0:n,o=a.y,t=o===void 0?0:o,l=a.width,v=a.height,d=a.src,u=a.shadowColor,y=a.shadowBlur,p,g=l,h=v;if(we(d)?p=this.imagePool.getImageSync(d):(g||(g=d.width),h||(h=d.height),p=d),p){var f=!M(u)&&y>0;j(r,e,f);try{e.drawImage(p,s,t,g,h)}catch{}}},i}(),Oe=function(){function i(e){this.imagePool=e}return i.prototype.render=function(e,a,r,n,s,o){r.getBounds();var t=a,l=t.lineWidth,v=l===void 0?1:l,d=t.textAlign,u=d===void 0?"start":d,y=t.textBaseline,p=y===void 0?"alphabetic":y,g=t.lineJoin,h=g===void 0?"miter":g,f=t.miterLimit,m=f===void 0?10:f,c=t.letterSpacing,T=c===void 0?0:c,A=t.stroke,N=t.fill,E=t.fillRule,B=t.fillOpacity,R=B===void 0?1:B,O=t.strokeOpacity,L=O===void 0?1:O,k=t.opacity,F=k===void 0?1:k,S=t.metrics,I=t.x,D=I===void 0?0:I,C=t.y,H=C===void 0?0:C,Q=t.dx,ee=t.dy,re=t.shadowColor,P=t.shadowBlur,J=S.font,X=S.lines,W=S.height,V=S.lineHeight,$=S.lineMetrics;e.font=J,e.lineWidth=v,e.textAlign=u==="middle"?"center":u;var _=p;!o.enableCSSParsing&&_==="alphabetic"&&(_="bottom"),e.lineJoin=h,M(m)||(e.miterLimit=m);var b=H;p==="middle"?b+=-W/2-V/2:p==="bottom"||p==="alphabetic"||p==="ideographic"?b+=-W:(p==="top"||p==="hanging")&&(b+=-V);var ue=D+(Q||0);b+=ee||0,X.length===1&&(_==="bottom"?(_="middle",b-=.5*W):_==="top"&&(_="middle",b+=.5*W)),e.textBaseline=_;var pe=!M(re)&&P>0;j(r,e,pe);for(var U=0;U<X.length;U++){var se=v/2+ue;b+=V,!M(A)&&!A.isNone&&v&&this.drawLetterSpacing(e,r,X[U],$[U],u,se,b,T,N,E,R,A,L,F,!0,n,s,o),M(N)||this.drawLetterSpacing(e,r,X[U],$[U],u,se,b,T,N,E,R,A,L,F,!1,n,s,o)}},i.prototype.drawLetterSpacing=function(e,a,r,n,s,o,t,l,v,d,u,y,p,g,h,f,m,c){if(l===0){h?this.strokeText(e,a,r,o,t,y,p,f,m,c):this.fillText(e,a,r,o,t,v,d,u,g,f,m,c);return}var T=e.textAlign;e.textAlign="left";var A=o;s==="center"||s==="middle"?A=o-n.width/2:(s==="right"||s==="end")&&(A=o-n.width);for(var N=Array.from(r),E=e.measureText(r).width,B=0,R=0;R<N.length;++R){var O=N[R];h?this.strokeText(e,a,O,A,t,y,p,f,m,c):this.fillText(e,a,O,A,t,v,d,u,g,f,m,c),B=e.measureText(r.substring(R+1)).width,A+=E-B+l,E=B}e.textAlign=T},i.prototype.fillText=function(e,a,r,n,s,o,t,l,v,d,u,y){ve(e,a,o,t,d,u,y,this.imagePool,!0);var p,g=!M(l)&&l!==1;g&&(p=e.globalAlpha,e.globalAlpha=l*v),e.fillText(r,n,s),g&&(e.globalAlpha=p)},i.prototype.strokeText=function(e,a,r,n,s,o,t,l,v,d){ne(e,a,o,l,v,d,this.imagePool,!0);var u,y=!M(t)&&t!==1;y&&(u=e.globalAlpha,e.globalAlpha=t),e.strokeText(r,n,s),y&&(e.globalAlpha=u)},i}();(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);(function(i){Y(e,i);function e(){return i!==null&&i.apply(this,arguments)||this}return e})(G);var Le=function(i){Y(e,i);function e(a){a===void 0&&(a={});var r=i.call(this)||this;return r.options=a,r.name="canvas-renderer",r}return e.prototype.init=function(){var a,r=te({dirtyObjectNumThreshold:500,dirtyObjectRatioThreshold:.8},this.options),n=this.context.imagePool,s=new G(n),o=(a={},a[w.CIRCLE]=s,a[w.ELLIPSE]=s,a[w.RECT]=s,a[w.IMAGE]=new Me(n),a[w.TEXT]=new Oe(n),a[w.LINE]=s,a[w.POLYLINE]=s,a[w.POLYGON]=s,a[w.PATH]=s,a[w.GROUP]=void 0,a[w.HTML]=void 0,a[w.MESH]=void 0,a);this.context.defaultStyleRendererFactory=o,this.context.styleRendererFactory=o,this.addRenderingPlugin(new Re(r))},e.prototype.destroy=function(){this.removeAllRenderingPlugins(),delete this.context.defaultStyleRendererFactory,delete this.context.styleRendererFactory},e}(ge);export{Le as P};
